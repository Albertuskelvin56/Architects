<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tambah/Edit Data Proyek</title>
    <link rel="stylesheet" href="style.css">
    <style>
        * {
            font-family: "Poppins", sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            outline: none;
            border: none;
            scroll-behavior: smooth;
            user-select: none;
            text-decoration: none;
        }

        :root {
            --text-color: #fff;
            --bg-color: #003366;

            --satu-color: #336699;
            --dua-color: #6699CC;
            --tiga-color: #001a33;
        }
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f9f9f9;
            background-image: url(IMG/blog.jpg);
        }
        form {
            max-width: 600px;
            display: flex;
            flex-direction: column;
            margin: auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        form h2 {
            text-align: center;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
        }
        input, textarea, select {
            width: 98%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        img{
            width: 100%;
        }
        .containerForm{
            width: 100%;
            display: flex;
            flex-direction: column;
        }
        textarea {
            resize: vertical;
        }
        button {
            width: 100%;
            padding: 10px;
            background-color: var(--bg-color);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }
        button:hover {
            background-color: var(--bg-color);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background-color: #fff;
        }
        table th, table td {
            padding: 10px;
            border: 1px solid #ccc;
            text-align: left;
        }
        table th {
            background-color: #f4f4f4;
        }
        .actions{
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .actions button {
            margin-right: 5px;
            padding: 5px 10px;
            font-size: 14px;
        }
        #loading {
            display: none;
        }
        .headingPr{
            color: white;
        }
        .logo{
            width: 100px;
            height: auto;
        }
        .a-logo{
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
        }
    </style>
</head>
<body>
    
    <main>
    <a href="index.html" class="a-logo">
        <div class="logo">
            <img src="./IMG/logo.png" alt="">
        </div>
    </a>
    <form id="proyekForm">
    <div class="containerForm">
        <h2 id="formTitle">Tambah Data Proyek</h2>
        <input type="hidden" id="id_projek" name="id_projek"> <!-- Hidden input for editing -->

        <div class="form-group">
            <label for="nama_pj">Nama Proyek</label>
            <input type="text" id="nama_pj" name="nama_pj" required>
        </div>
        <div class="form-group">
            <label for="foto_file">Foto Proyek (file)</label>
            <input type="file" id="foto_file" name="foto_file" accept="image/*">
        </div>
        <p id="loading">Mengunggah gambar...</p>
        <div class="form-group">
            <label for="foto_pj">Foto Proyek (url)</label>
            <input type="text" id="foto_pj" name="foto_pj" accept="image/*">
        </div>
        <div class="form-group">
            <img src="" id="preview-img" alt="">
        </div>
        <div class="form-group">
            <label for="alamat_pj">Alamat Proyek</label>
            <textarea id="alamat_pj" name="alamat_pj" rows="3" required></textarea>
        </div>
        <div class="form-group">
            <label for="jenis_layanan">Jenis Layanan</label>
            <select id="jenis_layanan" name="jenis_layanan" required>
                <option value="konstruksi">Konstruksi</option>
                <option value="arsitektur">Arsitektur</option>
            </select>
        </div>
        <div class="form-group">
            <label for="luas_tanah">Luas Tanah (m²)</label>
            <input type="number" id="luas_tanah" name="luas_tanah" required>
        </div>
        <div class="form-group">
            <label for="luas_bangunana">Luas Bangunan (m²)</label>
            <input type="number" id="luas_bangunana" name="luas_bangunana" required>
        </div>
        <div class="form-group">
            <label for="kamar_tidur">Kamar Tidur</label>
            <input type="number" id="kamar_tidur" name="kamar_tidur" required>
        </div>
        <div class="form-group">
            <label for="kamar_mandi">Kamar Mandi</label>
            <input type="number" id="kamar_mandi" name="kamar_mandi" required>
        </div>
        <div class="form-group">
            <label for="kamar_art">Kamar ART</label>
            <input type="number" id="kamar_art" name="kamar_art">
        </div>
        <div class="form-group">
            <label for="kapasitas_mobil">Kapasitas Mobil</label>
            <input type="number" id="kapasitas_mobil" name="kapasitas_mobil">
        </div>
        <div class="form-group">
            <label for="lantai">Jumlah Lantai</label>
            <input type="number" id="lantai" name="lantai" required>
        </div>
        <div class="form-group">
            <label for="pendukung">Fasilitas Pendukung</label>
            <textarea id="pendukung" name="pendukung" rows="3"></textarea>
        </div>
        <div class="form-group">
            <label for="gaya_bangunan">Gaya Bangunan</label>
            <input type="text" id="gaya_bangunan" name="gaya_bangunan" required>
        </div>
        <div class="form-group">
            <label for="deskripsi">Deskripsi</label>
            <textarea id="deskripsi" name="deskripsi" rows="5"></textarea>
        </div>

        <button type="submit" id="btn">Tambah Proyek</button>
    </div>
    </form>
    <div>
        <h2 class="headingPr">Daftar Proyek</h2>
        <table id="proyekTable">
            <thead>
                <tr>
                    <th>Nama Proyek</th>
                    <th>Deskripsi</th>
                    <th>Aksi</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    </main>

    <script>

function showLoading(progress = 0) {
        document.getElementById('loading').style.display = 'flex';
        document.getElementById('btn').textContent = 'Sedang Mengunggah...';
        document.getElementById("btn").disabled = true;
    }

    function hideLoading() {
        document.getElementById('loading').style.display = 'none';
        document.getElementById("btn").disabled = false;
    }
    

    document.getElementById('foto_file').addEventListener('change', async function (event) {
        const file = event.target.files[0];
        if (!file) {
            console.log('No file selected!');
            return;
        }

        showLoading(); 
        

        const reader = new FileReader();
        reader.onload = async function (e) {
            const base64Data = e.target.result.split(',')[1];

            const imgurUploadURL = 'https://api.imgur.com/3/image';
            const clientID = '6da7fcd6fcd2d5c';

            try {
                const response = await fetch(imgurUploadURL, {
                    method: 'POST',
                    headers: {
                        Authorization: `Client-ID ${clientID}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        image: base64Data,
                        type: 'base64',
                    }),
                });

                const result = await response.json();
                if (result.success) {
                    const imageURL = result.data.link; 
                    document.getElementById('foto_pj').value = imageURL; 
                    document.getElementById('preview-img').src = imageURL; 
                    console.log('Imgur URL:', imageURL);
                    document.getElementById('loading').textContent = 'Gambar berhasil diunggah';
                    document.getElementById('btn').textContent = 'Tambah Proyek';
                } else {
                    console.error('Upload failed:', result);
                }
            } catch (error) {
                console.error('Error uploading to Imgur:', error);
            } finally {
                hideLoading(); 
            }
        };
        reader.readAsDataURL(file);
    });

        async function fetchProyek() {
            try {
                const response = await fetch('https://sol-stru-server.vercel.app/api/projek');
                const result = await response.json();

                if (result.success) {
                    const tableBody = document.querySelector('#proyekTable tbody');
                    tableBody.innerHTML = '';

                    result.data.forEach(projek => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${projek.nama_pj}</td>
                            <td>${projek.deskripsi}</td>
                            <td class="actions">
                                <button onclick="editProyek('${projek.pjid}')">Edit</button>
                                <button onclick="deleteProyek('${projek.pjid}')">Delete</button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                } else {
                    alert('Gagal mengambil data proyek.');
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                alert('Terjadi kesalahan saat memuat data.');
            }
        }

        async function deleteProyek(id) {
            if (!confirm('Yakin ingin menghapus proyek ini?')) return;

            try {
                const response = await fetch(`https://sol-stru-server.vercel.app/api/projek/${id}`, {
                    method: 'DELETE',
                });

                if (response.ok) {
                    alert('Proyek berhasil dihapus.');
                    fetchProyek();
                } else {
                    alert('Gagal menghapus proyek.');
                }
            } catch (error) {
                console.error('Error deleting data:', error);
                alert('Terjadi kesalahan saat menghapus data.');
            }
        }

        async function editProyek(id) {
            try {
                const response = await fetch(`https://sol-stru-server.vercel.app/api/projek/${id}`);
                const result = await response.json();

                if (result.success) {
                    const projek = result.data;
                    
                    document.getElementById('id_projek').value = projek.pjid;
                    document.getElementById('nama_pj').value = projek.nama_pj;
                    document.getElementById('deskripsi').value = projek.deskripsi;
                    document.getElementById('foto_pj').value = projek.foto_pj;
                    document.getElementById('alamat_pj').value = projek.alamat_pj;
                    document.getElementById('jenis_layanan').value = projek.jenis_layanan;
                    document.getElementById('luas_tanah').value = projek.luas_tanah;
                    document.getElementById('luas_bangunana').value = projek.luas_bangunana;
                    document.getElementById('kamar_tidur').value = projek.kamar_tidur;
                    document.getElementById('kamar_mandi').value = projek.kamar_mandi;
                    document.getElementById('kamar_art').value = projek.kamar_art;
                    document.getElementById('kapasitas_mobil').value = projek.kapasitas_mobil;
                    document.getElementById('lantai').value = projek.lantai;
                    document.getElementById('pendukung').value = projek.pendukung;
                    document.getElementById('gaya_bangunan').value = projek.gaya_bangunan;
                    document.getElementById('preview-img').src = projek.foto_pj;

                    document.getElementById('formTitle').textContent = 'Edit Data Proyek';
                    document.getElementById('btn').textContent = 'Update Proyek';
                } else {
                    alert('Proyek tidak ditemukan.');
                }
            } catch (error) {
                console.error('Error fetching detail:', error);
                alert('Terjadi kesalahan saat mengambil data proyek.');
            }
        }

        document.querySelector('#proyekForm').addEventListener('submit', async (event) => {
            event.preventDefault();

            showLoading(); 

            const id = document.getElementById('id_projek').value;
            const formData = new FormData(event.target);

            const url = id
                ? `https://sol-stru-server.vercel.app/api/projek/${id}`
                : 'https://sol-stru-server.vercel.app/api/projek';

            const method = id ? 'PUT' : 'POST';

            const urlEncodedData = new URLSearchParams();
                formData.forEach((value, key) => {
                urlEncodedData.append(key, value);
            });

            try {
                const response = await fetch(url, {
                    method,
                    headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: urlEncodedData.toString(),
                });

                if (response.ok) {
                    alert(id ? 'Proyek berhasil diperbarui.' : 'Proyek berhasil ditambahkan.');
                    hideLoading();
                    document.getElementById('proyekForm').reset();
                    document.getElementById('formTitle').textContent = 'Tambah Data Proyek';
                    document.getElementById('btn').textContent = 'Tambah Proyek';
                    fetchProyek();
                } else {
                    alert('Gagal menyimpan data proyek.');
                }
            } catch (error) {
                console.error('Error saving data:', error);
                alert('Terjadi kesalahan saat menyimpan data.');
            }
        });

        fetchProyek();
    </script>
</body>
</html>
